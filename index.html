<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Preftrain – Prefilled Link & QR Generator</title>
<style>
  :root {
    --bg:#f4f5f7; --text:#1f2937; --muted:#6b7280;
    --primary:#006341; --radius:14px;
  }
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    background:var(--bg);color:var(--text);
    margin:0;padding:40px 16px;display:flex;justify-content:center;
  }
  .card{
    background:white;border-radius:var(--radius);
    padding:32px;box-shadow:0 6px 20px rgba(0,0,0,0.06);
    width:100%;max-width:600px;text-align:center;
  }
  .logo{width:180px;margin-bottom:10px;}
  h1{margin-top:0;color:var(--primary);font-size:1.8rem;margin-bottom:8px;}
  p.sub{color:var(--muted);margin-bottom:30px;font-size:0.95rem;}
  label{display:block;margin-top:12px;font-weight:600;text-align:left;}
  input[type="text"],input[type="date"]{
    width:100%;padding:10px;font-size:1rem;border:1px solid #ccc;
    border-radius:6px;background:#fff;
  }
  input[type="date"]::-webkit-calendar-picker-indicator{
    filter: invert(29%) sepia(93%) saturate(557%) hue-rotate(102deg) brightness(95%) contrast(92%);
    cursor:pointer;
  }
  .btn{
    background:var(--primary);color:white;border:none;border-radius:8px;
    padding:12px 16px;font-weight:600;cursor:pointer;margin-top:20px;
    width:100%;font-size:1rem;
  }
  .btn:hover{background:#055a37;}
  textarea{
    width:100%;height:80px;border-radius:6px;margin-top:10px;
    padding:10px;resize:none;
  }
  .actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
  #qrcode canvas,#qrcode img{
    border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);
  }
  .muted{color:var(--muted);font-size:0.85rem;text-align:center;margin-top:20px;}
</style>
</head>
<body>
<div class="card">
  <img src="preftrain-logo.png" alt="Preftrain Logo" class="logo" />
  <h1>Preftrain QR Generator</h1>
  <p class="sub">Generate a prefilled Microsoft Forms QR code for your training sessions.</p>

  <label>Program ID (Optional)</label>
  <input id="program" type="text" />

  <label>Organisation Name</label>
  <input id="org" type="text" />

  <label>Course Name</label>
  <input id="course" type="text" />

  <label>Course Date</label>
  <input id="date" type="date" />

  <button class="btn" onclick="generate()">Generate Prefilled Link + QR</button>

  <div id="result" style="display:none;">
    <label>Prefilled Link</label>
    <textarea id="linkBox" readonly></textarea>
    <div class="actions">
      <button class="btn" onclick="copyLink()">Copy Link</button>
      <button class="btn" onclick="openLink()">Open Link</button>
    </div>
    <div id="qrcode" style="margin-top:30px;text-align:center;"></div>
    <div class="actions">
      <button class="btn" onclick="downloadQR()">Download QR</button>
    </div>
  </div>

  <p class="muted">© Preferred Training Networks</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
const BASE_URL =
  "https://forms.office.com/Pages/ResponsePage.aspx?id=MM0eeTdhP0ibsyDIs89tvRLa7B5tOdpDp4y5sOvtxP5UNFcyVEtWMkhWTFk1VklCRFZMUkc4UFhPSS4u";
const FIELD_MAP = {
  Program:"r9999999999999999999999999999999", // replace when known
  OrgName:"r008e793a85004c2a894c4bb82b4c7e9e",
  CourseName:"r3430ce1c27084def9bd441bcff2e79c4",
  Date:"r8479996d49dd4bc680c6a2af9c56138d"
};

function generate(){
  const program=document.getElementById("program").value.trim();
  const org=document.getElementById("org").value.trim();
  const course=document.getElementById("course").value.trim();
  const dateRaw=document.getElementById("date").value; // yyyy-mm-dd from <input type="date">

  if(!org||!course||!dateRaw){
    alert("Please fill in Program ID (optional), Organisation, Course and Date.");
    return;
  }

  // Convert date for display only
  const dParts = dateRaw.split("-");
  const displayDate = dParts.length===3 ? `${dParts[2]}/${dParts[1]}/${dParts[0]}` : dateRaw;

  const data = {
    [FIELD_MAP.OrgName]: org,
    [FIELD_MAP.CourseName]: course,
    [FIELD_MAP.Date]: dateRaw  // Keep YYYY-MM-DD for Forms compatibility
  };
  if(program) data[FIELD_MAP.Program] = program;

  const params = new URLSearchParams(data);
  const encoded = params.toString().replace(/\+/g, "%20");
  const sep = BASE_URL.includes("?") ? "&" : "?";
  const link = `${BASE_URL}${sep}${encoded}`;

  document.getElementById("linkBox").value = link;
  document.getElementById("result").style.display = "block";

  const qEl = document.getElementById("qrcode");
  qEl.innerHTML = "";
  new QRCode(qEl, {
    text: link,
    width: 256,
    height: 256,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.M
  });
}
function copyLink(){
  const text=document.getElementById("linkBox").value;
  navigator.clipboard.writeText(text)
    .then(()=>alert("Link copied to clipboard!"))
    .catch(()=>alert("Failed to copy link."));
}
function openLink(){
  const link=document.getElementById("linkBox").value;
  window.open(link,"_blank");
}
function downloadQR(){
  const qEl=document.getElementById("qrcode");
  const canvas=qEl.querySelector("canvas");
  const img=qEl.querySelector("img");
  let dataURL=null;
  if(canvas){dataURL=canvas.toDataURL("image/png");}
  else if(img){dataURL=img.src;}
  else{alert("Generate the QR first!");return;}
  const a=document.createElement("a");
  a.download="preftrain_qr.png";
  a.href=dataURL;
  a.click();
}
</script>
</body>
</html>
